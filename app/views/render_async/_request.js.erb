if (window.jQuery) {
  (function($) {
    $(document).ready(function() {
      var headers = <%= headers.to_json.html_safe %>;
      var csrfTokenElement = document.querySelector('meta[name="csrf-token"]')
      if (csrfTokenElement)
        headers['X-CSRF-Token'] = csrfTokenElement.content

      $.ajax({
        url: '<%= path.html_safe %>',
        method: '<%= method %>',
        data: "<%= escape_javascript(data.to_s.html_safe) %>",
        headers: headers
      }).always(function(response) {
        $("#<%= container_id %>").replaceWith(response);

        <% if event_name.present? %>
          var event = undefined;
          if (typeof(Event) === 'function') {
            event = new Event("<%= event_name %>")
          } else {
            event = document.createEvent('<%= event_name %>_render_async');
            event.initEvent('<%= event_name %>', true, true);
          }
          document.dispatchEvent(event);
        <% end %>
      });
    });
  }(jQuery));
} else {
  (function() {
    document.addEventListener("DOMContentLoaded", function() {
      var request = new XMLHttpRequest();
      var asyncRequest = true;
      var SUCCESS = 200;
      var ERROR = 400;

      request.open('<%= method %>', '<%= path.html_safe %>', asyncRequest);

      var headers = <%= headers.to_json.html_safe %>;
      var csrfTokenElement = document.querySelector('meta[name="csrf-token"]')
      if (csrfTokenElement)
        headers['X-CSRF-Token'] = csrfTokenElement.content

      Object.keys(headers).map(function(key) {
        request.setRequestHeader(key, headers[key]);
      });

      request.onload = function() {
        if (request.status >= SUCCESS && request.status < ERROR) {
          var container = document.getElementById('<%= container_id %>');
          container.outerHTML = request.response;

          <% if event_name.present? %>
            var event = undefined;
            if (typeof(Event) === 'function') {
              event = new Event("<%= event_name %>");
            } else {
              event = document.createEvent('<%= event_name %>_render_async');
              event.initEvent('<%= event_name %>', true, true);
            }
            document.dispatchEvent(event);
          <% end %>
        }
      };

      var body = "<%= escape_javascript(data.to_s.html_safe) %>";
      request.send(body);
    });
  })();
}
